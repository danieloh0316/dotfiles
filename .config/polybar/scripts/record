#!/bin/sh

update_icon() {
  polybar-msg action record hook $1
}

audio() { \
  ffmpeg \
  -f alsa -i default \
  -c:a flac \
  "$HOME/audio-$(date '+%y%m%d-%H%M-%S').flac" &
  echo $! > /tmp/recordingpid
  update_icon 1
}

screencast() { \
  ffmpeg \
  -f x11grab \
  -framerate 60 \
  -s 1920x1080 \
  -i :0.0+1680,0 \
  -f alsa -i default \
  -r 30 \
  -c:v h264 -crf 0 -preset ultrafast -c:a aac \
  "$HOME/screencast-$(date '+%y%m%d-%H%M-%S').mp4" &
  echo $! > /tmp/recordingpid
  update_icon 2
}

video() { \
  ffmpeg \
  -f x11grab \
  -framerate 60 \
  -s 1920x1080 \
  -i :0.0+1680,0 \
  -c:v libx264 -qp 0 -r 60 \
  "$HOME/video-$(date '+%y%m%d-%H%M-%S').mkv" &
  echo $! > /tmp/recordingpid
  update_icon 3
}

kill_recording() {
  RECPID="$(cat /tmp/recordingpid)"
  # kill with SIGTERM, allowing finishing touches.
  kill -15 "$RECPID"
  rm -f /tmp/recordingpid
  update_icon 0
  # even after SIGTERM, ffmpeg may still run, so SIGKILL it.
  sleep 3
  kill -9 "$RECPID"
}

stop_recording() {
  OPTION=$(printf "no\\nyes" | rofi -dmenu -i -p "Stop recording?")
  [ "$OPTION" = "yes" ] && kill_recording
  exit
}

start_recording() {
  OPTION=$(printf "audio\\nscreencast\\nvideo" | rofi -dmenu -i -p "Select recording style")
  case "$OPTION" in
    audio) audio;;
    screencast) screencast;;
    video) video;;
  esac
}

[ -f /tmp/recordingpid ] && stop_recording || start_recording
